<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тестове завантаження зображень</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        .upload-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            justify-content: center;
            max-width: 600px;
            margin: auto;
        }
        .upload-box {
            width: 120px;
            height: 160px;
            border-radius: 10px;
            border: 2px dashed #ccc;
            background-color: #eaeaea;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            transition: filter 0.8s ease-in-out;
        }
        .upload-box span {
            font-size: 32px;
            color: #aaa;
        }
        .upload-box .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            transition: background-color 0.3s;
            z-index: 2;
        }
        .upload-box .delete-btn:hover {
            background-color: red;
        }
        .delete-btn svg {
            width: 12px;
            height: 12px;
            fill: white;
        }
        .progress-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-90deg);
            width: 45px;
            height: 45px;
            display: block;
            z-index: 1;
        }
        .progress-ring circle {
            fill: none;
            stroke: lightgray;
            stroke-width: 4;
            stroke-dasharray: 113;
            stroke-dashoffset: 113;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .progress-ring .progress {
            stroke: lightgray;
            stroke-dasharray: 113;
            stroke-dashoffset: 113;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        .upload-box.loading .progress-ring {
            display: block;
        }
        .upload-box.has-image {
            background-color: #eee;
        }
        .upload-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s ease-in-out;
            filter: blur(8px);
            z-index: 0;
        }
        .upload-box img.loaded {
            filter: none;
        }
        .upload-box .error-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;

        }
        .upload-box .error-icon {
            font-size: 32px;
        }
        .upload-box .error-message {
            font-size: 12px;
            color: #ff0000;
            margin: 8px;
        }
    </style>
</head>
<body>
    <h2>Тестове завантаження зображень</h2>
    <div class="upload-container" id="uploadContainer"></div>

    <input type="file" id="fileInput" style="display: none;" accept="image/*">

    <script>
        const wsUrl = "ws://localhost:8000/image/upload";
        const dbName = "ImageUploadDB";
        const storeName = "images";
        const maxFiles = 10; // Maximum number of files
        const maxSize = 5 * 1024 * 1024; // 5 MB in bytes

        let ws = null;
        let uploadsCount = 0;
        let activeAction = null;
        let progressRing = null;
        let activeFileUpload = null;
        let activeFileDelete = null;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath: "index" });
                    }
                };

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function saveFileToDB(index, file, storedFileName) {
            return openDB().then((db) => {
                return new Promise((resolve, reject) => {
                    let dbKey = `${index}-${getSessionId()}`;
                    const transaction = db.transaction(storeName, "readwrite");
                    const store = transaction.objectStore(storeName);
                    const request = store.put({ index: dbKey, file, storedFileName });

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            });
        }

        function getFileFromDB(index) {
            return openDB().then((db) => {
                return new Promise((resolve, reject) => {
                    let dbKey = `${index}-${getSessionId()}`;
                    const transaction = db.transaction(storeName, "readonly");
                    const store = transaction.objectStore(storeName);
                    const request = store.get(dbKey);

                    request.onsuccess = () => resolve(request.result ? request.result : null);
                    request.onerror = () => reject(request.error);
                });
            });
        }

        function deleteFileFromDB(index) {
            return openDB().then((db) => {
                return new Promise((resolve, reject) => {
                    let dbKey = `${index}-${getSessionId()}`;
                    const transaction = db.transaction(storeName, "readwrite");
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(dbKey);

                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            });
        }

        function getUserId() {
            let userId = localStorage.getItem("userId");
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem("userId", userId);
            }
            return userId;
        }

        function getSessionId() {
            let sessionId = sessionStorage.getItem("sessionId");
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                sessionStorage.setItem("sessionId", sessionId);
            }
            return sessionId;
        }

        function updateSessionCount(value) {
            uploadsCount += value;
            sessionStorage.setItem("uploads", uploadsCount);
        }

        function showError(box, message) {
            box.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">⚠️</div>
                    <div class="error-message">${message}</div>
                </div>
            `;
            box.classList.remove("loading", "has-image");
        }

        function createDeleteButton() {
            const deleteBtn = document.createElement("button");
            deleteBtn.classList.add("delete-btn");
            deleteBtn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
            return deleteBtn;
        }

        function resetBox(box) {
            box.innerHTML = "<span>+</span><svg class='progress-ring'><circle cx='22.5' cy='22.5' r='18'></circle></svg>";
            box.classList.remove("loading", "has-image");
        }

        function addImageToBox(box, file) {
            progressRing = null;
            const imgTag = document.createElement("img");
            const deleteBtn = createDeleteButton();

            imgTag.src = URL.createObjectURL(file);

            imgTag.onload = () => {
                setTimeout(() => imgTag.classList.add("loaded"), 1);

                box.classList.remove("loading");
                box.classList.add("has-image");
                box.innerHTML = "";

                box.appendChild(imgTag);
                box.appendChild(deleteBtn);
            };
        }

        // Створення та відображення інтерфейсу завантаження
        function createProgressUI(file, box) {
            const imgTag = document.createElement("img");
            imgTag.src = URL.createObjectURL(file);

            box.classList.add("loading");
            box.innerHTML = `<svg class='progress-ring'><circle cx='22.5' cy='22.5' r='18'></circle></svg>`;
            box.appendChild(imgTag);

            return box.querySelector(".progress-ring circle");
        }

        // Створюємо або отримуємо WebSocket-з'єднання
        function getWebSocket() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                ws = new WebSocket(wsUrl);
                ws.onopen = () => console.log("WebSocket відкрито");
                ws.onmessage = handleServerResponse;
                ws.onerror = (error) => console.error("WebSocket помилка:", error);
                ws.onclose = () => {
                    console.log("WebSocket закрито");
                    ws = null;
                };
            }
            return ws;
        }

        // Обробка відповідей від сервера
        function handleServerResponse(event, resolve) {
            if (!activeAction) return;

            const data = JSON.parse(event.data);

            if (activeAction.type === "upload") {
                handleUploadResponse(data, resolve);
            } else if (activeAction.type === "delete") {
                handleDeleteResponse(data);
            }
        }

        // Завантаження файлу
        function uploadFile(file, index, box) {
            if (uploadsCount >= maxFiles) {
                const message = "Перевищено ліміт завантажень!";
                console.error(message);
                showError(box, message);
                return;
            }

            if (file.size > maxSize) {
                const message = "Розмір файлу перевищує 5 МБ";
                console.error(message);
                showError(box, message);
                return;
            }

            activeAction = { type: "upload", file, index, box };
            const ws = getWebSocket();

            // Функція запиту на завантаження
            function sendUploadRequest() {
                activeFileUpload = {file, index, box};
                ws.send(JSON.stringify({
                    action: "upload",
                    user_id: getUserId(),
                    session_id: getSessionId(),
                    file_name: file.name,
                    file_idx: index
                }));
            }

            if (ws.readyState === WebSocket.OPEN) {
                sendUploadRequest();
            } else if (ws.readyState === WebSocket.CONNECTING) {
                ws.addEventListener("open", sendUploadRequest, { once: true });
            }
        }

        // Функція для поетапного завантаження файлу
        function sendFile(file) {
            if (!file) return;
            const reader = new FileReader();

            reader.onload = async (event) => {
                const chunkSize = 1024 * 256;
                const data = event.target.result;
                let offset = 0;

                while (offset < data.byteLength && activeFileUpload) {
                    const chunk = data.slice(offset, offset + chunkSize);

                    await new Promise((resolve) => {
                        ws.onmessage = (event) => {
                            handleServerResponse(event, resolve);
                        };

                        if (ws.readyState === WebSocket.OPEN) {
                            ws.send(chunk);
                        }
                    });

                    offset += chunkSize;
                }

                // Відправляємо сигнал закінчення завантаження
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(new TextEncoder().encode("EOF"));
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // Обробка відповіді від сервера
        function handleUploadResponse(data, resolve) {
            if (!activeFileUpload) return;

            const { file, index, box } = activeFileUpload;
            const progress = data.progress;
            const dashOffset = 113 - (113 * (progress / 100));

            progressRing = progressRing || createProgressUI(file, box);
            progressRing.style.strokeDashoffset = `${dashOffset}`;

            if (data.status === "ready") {
                saveFileToDB(index, file, data.file_name).then(() => {
                    sendFile(file);
                });
            } else if (data.status === "uploading") {
                resolve();
            } else if (data.status === "success") {
                updateSessionCount(1);
                saveFileToDB(index, file, data.file_name).then(() => {
                    setTimeout(() => {
                        addImageToBox(box, file);
                        activeFileUpload = null;
                        console.log("Файл завантажено:", file.name, "Розмір:", file.size);
                    }, 1000);
                });
            } else if (data.status === "abort" || data.status === "timeout") {
                deleteFileFromDB(index);
                activeFileUpload = null;
                showError(box, data.message);
                console.log("Завантаження прервано:", data.message);
            } else if (data.status === "error") {
                deleteFileFromDB(index);
                activeFileUpload = null;
                showError(box, data.message);
                console.error("Помилка завантаження:", data.message);
            }
        }

        // Видалення файлу
        function deleteFile(index, box) {
            getFileFromDB(index).then((result) => {
                const fileName = result.storedFileName;

                activeAction = { type: "delete", index, box };
                const ws = getWebSocket();

                function sendDeleteRequest() {
                    activeFileDelete = { index, box };
                    ws.send(JSON.stringify({
                        action: "delete",
                        user_id: getUserId(),
                        session_id: getSessionId(),
                        file_name: fileName,
                        file_idx: index
                    }));
                }

                if (ws.readyState === WebSocket.OPEN) {
                    sendDeleteRequest();
                } else if (ws.readyState === WebSocket.CONNECTING) {
                    ws.addEventListener("open", sendDeleteRequest, { once: true });
                }
            });
        }

        // Обробка відповіді на видалення
        function handleDeleteResponse(data) {
            const { index, box } = activeAction;

            if (data.status === "success") {
                console.log("Файл видалено:", data.file_name);
                deleteFileFromDB(index).then(() => resetBox(box));
                updateSessionCount(-1);
            } else if (data.status === "error") {
                console.error("Помилка видалення:", data.message);
            }
        }

        // Відновлення зображень при завантаженні сторінки
        function restoreImages() {
            const uploadContainer = document.getElementById("uploadContainer");
            for (let i = 0; i < 10; i++) {
                const box = document.createElement("div");

                box.classList.add("upload-box");
                box.dataset.index = String(i);
                resetBox(box); // Set initial state

                box.addEventListener("click", () => {
                    if (!box.classList.contains("has-image")) {
                        document.querySelector("#fileInput").dataset.index = box.dataset.index;
                        document.querySelector("#fileInput").click();
                    }
                });

                // Отримання зображення з IndexedDB
                getFileFromDB(i).then((result) => {
                    if (result?.file) {
                        result.storedFileName // Перевірка збереженого ім'я файлу
                            ? addImageToBox(box, result.file)  // Додаємо зображення
                            : uploadFile(result.file, i, box);  // Завантажуємо файл
                    }
                });

                uploadContainer.appendChild(box);
            }
        }

        document.querySelector("#fileInput").addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const index = Number(event.target.dataset.index);
            const box = document.querySelector(`.upload-box[data-index='${index}']`);

            uploadFile(file, index, box);

            // Скидання вхідного значення
            event.target.value = "";
        });

        // Восстановление состояния при загрузке страницы
        window.addEventListener("load", () => {
            uploadsCount = Number(sessionStorage.getItem("uploads")) || 0;
            restoreImages();
        });

        document.addEventListener("click", (event) => {
            if (event.target.classList.contains("delete-btn") || event.target.closest(".delete-btn")) {
                const box = event.target.closest(".upload-box");
                const index = Number(box.dataset.index);
                deleteFile(index, box);
            }
        });
    </script>
</body>
</html>